<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>微信授权登录</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
      .spinner {
        width: 40px;
        height: 40px;
        margin: 0 auto;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="loading">
      <div class="spinner"></div>
      <p>正在登录，请稍候...</p>
    </div>

    <script>
      const http = {
        post: function (path, params) {
          return axios
            .post("/api" + path, params, {
              headers: {
                "Content-Type": "application/json",
                token: localStorage.getItem("token"),
              },
            })
            .then((res) => {
              if (res.data.code === -9001) {
                localStorage.removeItem("token");
                window.location.href = "/login";
                return Promise.reject(res.data);
              }
              if (res.data.code !== 0) {
                console.error("Response error:", res.data);
                return Promise.reject(res.data);
              }
              return res.data;
            })
            .catch((error) => {
              console.error("Request failed:", error);
              if (error.response) {
                console.error("Error status:", error.response.status);
                console.error("Error data:", error.response.data);
                return Promise.reject(error.response.data);
              }
              return Promise.reject({
                message: error.message || "网络请求失败",
              });
            });
        },
      };

      // 1. 从 URL 中提取 code 和 key
      alert(window.location.href);
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");
      const key = urlParams.get("key");

      if (!code || !key) {
        alert("微信授权失败：缺少必要参数");
        window.history.back();
        throw new Error("缺少code 或 key 参数");
      }

      // 2. 调用授权接口
      http
        .post("/login/wxAuthLogin", { code, key })
        .then((response) => {
          if (response.code !== 0) {
            throw new Error(response.msg || "授权失败");
          }
          window.close();
        })
        .catch((error) => {
          const errorMsg = error.msg || "网络请求失败";
          alert(`授权失败：${errorMsg}`);
          window.history.back();
        });
    </script>
  </body>
</html>
